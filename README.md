# ReadingIsGood API Documentation
## How to run?
- You can simply run the `docker-compose up -d` command and start using the API. 
- Postman collection can be found under [/postman](/postman) folder.
- Postgres is initialized via script under [/db](/db) folder. 
- A test user is initialized for further usages of the API. JWT can be received with this user from /login endpoint.
  - email: test@test.com
  - password: 123456
- All requests must include:
    - `x-api-key` header. (`x-api-key: 989fe8e4-1066-44be-9fd4-0b7ecfeecef6`)
    - JWT, generated by authentication-service (_except for login request_). (`Authorization: Bearer <JWT>`)
- Centralized logging is commented out from docker-compose file due to high memory consumption. 
Related Logstash configuration can be found under [/elk](elk) folder.
- Swagger becomes available at http://localhost:8080/swagger-ui/index.html#/ after spinning up the containers.

## Tech Stack
- **Language**: Java 21
- **Framework**: Spring Boot 3.2
- **Databases**:
  - **Postgres**: For business logic that requires ACID
  - **Mongo**: For storing entity history logs
  - **Elasticsearch**: For storing application logs
- **Cache**: Spring Cache Abstraction
- **Messaging**: Apache Kafka
- **Testing**: JUnit, Mockito, Jacoco
- **API Documentation**: OpenAPI (Swagger)

## Architecture
![rig_services.jpeg](images%2Frig_services.jpeg)

1. api-gateway
    - Entry point of the application
    - Responsible for API security
    - Responsible for data validation
    - Have circuit breaker and rate limiter
    - Secured with an api-key and JWT
    - Invokes target services via **Feign Client**
2. authentication-service
   - Generates JWT for registered users
3. book-service
   - Responsible for book creation and inventory tracking
4. customer-service
    - Responsible for customer creation and customer related operations
5. order-service
   - Responsible for order creation and order related operations
   - Have multiple caches (Spring Cache Abstraction is used due to its simplicity)
6. statistics service
   - Responsible for providing statistical data
7. history-service
   - Keeps track of all changes on entities

## Data Model
![er_diagram.png](images%2Fer_diagram.png)

- All tables have audit fields that populated automatically via Spring's JPA auditing.

## Security
- Application is protected with an api-key and a JWT.
- `app.security.allowedOrigins` parameter can be modified for allowed origins to accept requests from.
- Utilized Resilience4j's circuit-breaker and rate-limiter for fault tolerance.
- Request payloads are validated to prevent corrupt data.

## Tracing
- Some custom headers are used for request tracing. These headers are added within api-gateway via request interceptors.
  - **x-correlation-id**: Random UUID to trace a request among services.
  - **x-executor-service**: Specifies the origin service of the incoming request.
  - **x-user-code**: Specifies the origin user of the incoming request. Extracted from JWT

## Logging
- All services have `HttpRequestResponseLogger` filter classes to log all incoming and outgoing traffic.
- All services have`GlobalExceptionHandler` classes to handle exceptions.
- ELK stack is utilized for centralized logging and log monitoring. 
All service logs are collected by Logstash, stored in Elasticsearch and can be monitored via Kibana dashboard.
- **history-service** is used to keep track of all entity updates. Services publish their events to their related **Kafka** topic,
then history-service consumes these events and writes to **MongoDB**.

## Testing
- **JUnit** and **Mockito** is used for testing.
- **Jacoco** is used as test coverage tool. Coverage results can be found under `target/site/jacoco/index.html` within services.
  
- authentication-service: 
![auth_service_jacoco.png](images%2Fauth_service_jacoco.png)
- book-service:
![book_service_jacoco.png](images%2Fbook_service_jacoco.png)
- customer-service:
![customer_service_jacoco.png](images%2Fcustomer_service_jacoco.png)
- order-service:
![order_service_jacoco.png](images%2Forder_service_jacoco.png)
- statistics service: 
![statistics_service_jacoco.png](images%2Fstatistics_service_jacoco.png)

# Deployment and Further Improvements
- A CI/CD pipeline can be added.
  - GitHub actions: When a merge occurs, build and prepare a new container. Then, push this container to AWS ECR.
  - AWS: ECR can be used as container registry. Containers can be managed via Kubernetes.
- Elastic APM or Grafana + Prometheus can be used for application monitoring.
- Authorization service can be improved to receive refresh tokens, besides that OAuth can be added.
- Test coverage can be improved.
- Distributed caching can be included if necessary.
- Exception handling can be improved.